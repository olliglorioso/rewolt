"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const dropoff_1 = require("../models/dropoff");
const order_1 = require("../models/order");
const wolt_1 = require("../lib/wolt");
const dumplocation_1 = require("../lib/dumplocation");
const user_1 = require("../models/user");
const router = (0, express_1.Router)();
router.get("/api/dropoffs", async (req, res) => {
    // get all dropoffs
    const dropoffs = await dropoff_1.default.find({});
    return res.json(dropoffs);
});
router.post("/api/listing/deliveryprice", async (req, res) => {
    // get delivery price
    const { orderId, address } = req.body;
    const order = await order_1.default.findById(orderId);
    if (!order) {
        return res.status(400).json({
            message: "Order not found",
        });
    }
    const dropoff = await dropoff_1.default.findById(order.dropoff);
    if (!dropoff) {
        return res.status(400).json({
            message: "Dropoff not found",
        });
    }
    const fee = await (0, wolt_1.getFee)(dropoff.address, address);
    return res.json({
        fee,
    });
});
router.post("/api/buy", async (req, res) => {
    // buy
    console.log(req.body);
    const { orderId, əddress } = req.body;
    console.log("ADDRESS IS", əddress);
    const order = await order_1.default.findById(orderId);
    if (!order || order.status !== "pending") {
        res.status(400).json({
            message: "Order not found",
        });
        return;
    }
    const dropoff = await dropoff_1.default.findById(order.dropoff);
    if (!dropoff) {
        res.status(400).json({
            message: "Dropoff not found",
        });
        return;
    }
    const seller = await user_1.default.findById(order.user);
    if (!seller) {
        res.status(400).json({
            message: "Seller not found",
        });
        return;
    }
    if (!req.user) {
        res.status(400).json({
            message: "User not found",
        });
        return;
    }
    console.log(dropoff, əddress, seller.email, seller.phone, req.user, order._id);
    const delivery = await (0, wolt_1.createDelivery)(dropoff.address, əddress, `dropoff - ${"Moi"} - ${"comment"}`, {
        name: seller.email,
        phone: seller.phone,
    }, {
        name: req.user.email,
        phone: req.user.phone,
    }, "dogi", "Electronis", order._id.toString(), "koira");
    order.status = "bought";
    await order.save();
    return res.json({
        delivery
    });
});
router.post("/api/fee", async (req, res) => {
    const { dropoffId, category } = req.body;
    const dropoff = await dropoff_1.default.findById(dropoffId);
    if (!dropoff) {
        return res.status(400).json({
            message: "Dropoff not found",
        });
    }
    const dumpLocation = await (0, dumplocation_1.getDumpLocation)(dropoff.lat, dropoff.lon, category);
    const fee = await (0, wolt_1.getFee)(dropoff.address, dumpLocation.streetAddress);
    return res.json(fee);
});
router.get("/api/listing", async (req, res) => {
    if (!req.user) {
        return res.status(401).json({
            message: "Unauthorized",
        });
    }
    const orders = await order_1.default.find({ status: "pending" });
    return res.json(orders);
});
router.post("/api/listing", async (req, res) => {
    try {
        if (!req.user) {
            return res.status(401).json({
                message: "You must be logged in",
            });
        }
        console.log(req.body);
        const { dropoffId, title, category, price } = req.body;
        const dropoff = await dropoff_1.default.findById(dropoffId);
        if (!dropoff) {
            return res.status(400).json({
                message: "Dropoff not found",
            });
        }
        const order = new order_1.default({
            dropoff,
            user: req.user,
            title: title,
            category: category,
            price,
            status: "pending"
        });
        await order.save();
        console.log("ready");
        return res.status(200).json({ "dog": "cat" });
    }
    catch (e) {
        console.log(e);
        return res.status(400);
    }
});
router.post("/api/order", async (req, res) => {
    if (!req.user) {
        return res.status(401).json({
            message: "You must be logged in",
        });
    }
    const { dropoffId, title, category } = req.body;
    const dropoff = await dropoff_1.default.findById(dropoffId);
    if (!dropoff) {
        return res.status(400).json({
            message: "Dropoff not found",
        });
    }
    const dumpLocation = await (0, dumplocation_1.getDumpLocation)(dropoff.lat, dropoff.lon, category);
    let delivery;
    try {
        delivery = await (0, wolt_1.createDelivery)(dropoff.address, dumpLocation.streetAddress, "dropoff box - " + title + " - " + category, {
            name: req.user.email,
            phone: req.user.phone || "+358404342342",
        }, {
            name: dumpLocation.streetAddress,
            phone: dumpLocation.phoneNumber,
        }, title, category, "", "");
        // create a new order and save it to mongodb
    }
    catch (err) {
        return res.status(400).json({
            message: "Error creating delivery",
        });
    }
    return res.json({
        delivery
    });
});
router.get("/api/history", async (req, res) => {
    try {
        const ordersByUser = await order_1.default.find({ user: req.user?._id });
        console.log(ordersByUser);
        return res.status(200).json(ordersByUser);
    }
    catch (err) {
        console.log(err);
        return res.status(400).json({ message: "some error" });
    }
});
exports.default = router;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLmpzIiwic291cmNlUm9vdCI6Ii4vc3JjLyIsInNvdXJjZXMiOlsicm91dGVzL2FwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFpQztBQUNqQywrQ0FBd0M7QUFDeEMsMkNBQW9DO0FBQ3BDLHNDQUFxRDtBQUNyRCxzREFBc0Q7QUFDdEQseUNBQWtDO0FBQ2xDLE1BQU0sTUFBTSxHQUFHLElBQUEsZ0JBQU0sR0FBRSxDQUFDO0FBRXhCLE1BQU0sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDN0MsbUJBQW1CO0lBQ25CLE1BQU0sUUFBUSxHQUFHLE1BQU0saUJBQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDeEMsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzVCLENBQUMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQzNELHFCQUFxQjtJQUNyQixNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7SUFDdEMsTUFBTSxLQUFLLEdBQUcsTUFBTSxlQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzVDLElBQUksQ0FBQyxLQUFLLEVBQUU7UUFDVixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxpQkFBaUI7U0FDM0IsQ0FBQyxDQUFDO0tBQ0o7SUFDRCxNQUFNLE9BQU8sR0FBRyxNQUFNLGlCQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN0RCxJQUFJLENBQUMsT0FBTyxFQUFFO1FBQ1osT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUMxQixPQUFPLEVBQUUsbUJBQW1CO1NBQzdCLENBQUMsQ0FBQztLQUNKO0lBRUQsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFBLGFBQU0sRUFBQyxPQUFPLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ25ELE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQztRQUNkLEdBQUc7S0FDSixDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDekMsTUFBTTtJQUNOLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3JCLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQztJQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQTtJQUNsQyxNQUFNLEtBQUssR0FBRyxNQUFNLGVBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDNUMsSUFBSSxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLFNBQVMsRUFBRTtRQUN4QyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNuQixPQUFPLEVBQUUsaUJBQWlCO1NBQzNCLENBQUMsQ0FBQztRQUNILE9BQU87S0FDUjtJQUNELE1BQU0sT0FBTyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3RELElBQUksQ0FBQyxPQUFPLEVBQUU7UUFDWixHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNuQixPQUFPLEVBQUUsbUJBQW1CO1NBQzdCLENBQUMsQ0FBQztRQUNILE9BQU87S0FDUjtJQUVELE1BQU0sTUFBTSxHQUFHLE1BQU0sY0FBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFL0MsSUFBRyxDQUFDLE1BQU0sRUFBRTtRQUNWLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ25CLE9BQU8sRUFBRSxrQkFBa0I7U0FDNUIsQ0FBQyxDQUFDO1FBQ0gsT0FBTztLQUNSO0lBQ0QsSUFBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUM7UUFDWCxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNuQixPQUFPLEVBQUUsZ0JBQWdCO1NBQzFCLENBQUMsQ0FBQztRQUNILE9BQU87S0FDUjtJQUNELE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDOUUsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFBLHFCQUFjLEVBQ25DLE9BQU8sQ0FBQyxPQUFPLEVBQ2YsT0FBTyxFQUNQLGFBQWEsS0FBSyxNQUFNLFNBQVMsRUFBRSxFQUNuQztRQUNFLElBQUksRUFBRSxNQUFNLENBQUMsS0FBSztRQUNsQixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUs7S0FDcEIsRUFDRDtRQUNFLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUs7UUFDcEIsS0FBSyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSztLQUN0QixFQUNELE1BQU0sRUFDTixZQUFZLEVBQ1osS0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsRUFDcEIsT0FBTyxDQUNSLENBQUE7SUFDRCxLQUFLLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQztJQUN4QixNQUFNLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNuQixPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDZCxRQUFRO0tBQ1QsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQ3pDLE1BQU0sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEdBQUcsR0FBRyxDQUFDLElBR25DLENBQUM7SUFDRixNQUFNLE9BQU8sR0FBRyxNQUFNLGlCQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2xELElBQUksQ0FBQyxPQUFPLEVBQUU7UUFDWixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSxtQkFBbUI7U0FDN0IsQ0FBQyxDQUFDO0tBQ0o7SUFDRCxNQUFNLFlBQVksR0FBRyxNQUFNLElBQUEsOEJBQWUsRUFBQyxPQUFPLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDL0UsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFBLGFBQU0sRUFBQyxPQUFPLENBQUMsT0FBTyxFQUFFLFlBQVksQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUN0RSxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDdkIsQ0FBQyxDQUFDLENBQUM7QUFJSCxNQUFNLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQzVDLElBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFDO1FBQ1gsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUMxQixPQUFPLEVBQUUsY0FBYztTQUN4QixDQUFDLENBQUM7S0FDSjtJQUNELE1BQU0sTUFBTSxHQUFHLE1BQU0sZUFBSyxDQUFDLElBQUksQ0FBQyxFQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUMsQ0FBQyxDQUFDO0lBQ3JELE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMxQixDQUFDLENBQUMsQ0FBQTtBQUVGLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDN0MsSUFBSTtRQUNGLElBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFO1lBQ1osT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDMUIsT0FBTyxFQUFFLHVCQUF1QjthQUNqQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3JCLE1BQU0sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFLakQsQ0FBQztRQUNGLE1BQU0sT0FBTyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQzFCLE9BQU8sRUFBRSxtQkFBbUI7YUFDN0IsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxNQUFNLEtBQUssR0FBRyxJQUFJLGVBQUssQ0FBQztZQUN0QixPQUFPO1lBQ1AsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJO1lBQ2QsS0FBSyxFQUFFLEtBQUs7WUFDWixRQUFRLEVBQUUsUUFBUTtZQUNsQixLQUFLO1lBQ0wsTUFBTSxFQUFFLFNBQVM7U0FDbEIsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUNwQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7S0FDOUM7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDZCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7S0FDdkI7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDM0MsSUFBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUU7UUFDWixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSx1QkFBdUI7U0FDakMsQ0FBQyxDQUFDO0tBQ0o7SUFDRCxNQUFNLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFJMUMsQ0FBQztJQUNGLE1BQU0sT0FBTyxHQUFHLE1BQU0saUJBQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDbEQsSUFBSSxDQUFDLE9BQU8sRUFBRTtRQUNaLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUIsT0FBTyxFQUFFLG1CQUFtQjtTQUM3QixDQUFDLENBQUM7S0FDSjtJQUVELE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBQSw4QkFBZSxFQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUMvRSxJQUFJLFFBQVEsQ0FBQztJQUNiLElBQUk7UUFFRixRQUFRLEdBQUcsTUFBTSxJQUFBLHFCQUFjLEVBQzdCLE9BQU8sQ0FBQyxPQUFPLEVBQ2YsWUFBWSxDQUFDLGFBQWEsRUFDMUIsZ0JBQWdCLEdBQUcsS0FBSyxHQUFHLEtBQUssR0FBRyxRQUFRLEVBQzNDO1lBQ0UsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSztZQUNwQixLQUFLLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksZUFBZTtTQUN6QyxFQUNEO1lBQ0UsSUFBSSxFQUFFLFlBQVksQ0FBQyxhQUFhO1lBQ2hDLEtBQUssRUFBRSxZQUFZLENBQUMsV0FBVztTQUNoQyxFQUNELEtBQUssRUFDTCxRQUFRLEVBQ1IsRUFBRSxFQUNGLEVBQUUsQ0FDSCxDQUFDO1FBQ0YsNENBQTRDO0tBRTdDO0lBQUMsT0FBTSxHQUFHLEVBQUM7UUFDVixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLE9BQU8sRUFBRSx5QkFBeUI7U0FDbkMsQ0FBQyxDQUFDO0tBQ0o7SUFFRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDZCxRQUFRO0tBQ1QsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQzVDLElBQUk7UUFDSixNQUFNLFlBQVksR0FBRyxNQUFNLGVBQUssQ0FBQyxJQUFJLENBQUMsRUFBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFBO1FBQzVELE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUE7UUFDekIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQTtLQUN4QztJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUNoQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLFlBQVksRUFBQyxDQUFDLENBQUE7S0FDckQ7QUFDSCxDQUFDLENBQUMsQ0FBQTtBQUdGLGtCQUFlLE1BQU0sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJvdXRlciB9IGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQgRHJvcG9mZiBmcm9tIFwiLi4vbW9kZWxzL2Ryb3BvZmZcIjtcbmltcG9ydCBPcmRlciBmcm9tIFwiLi4vbW9kZWxzL29yZGVyXCI7XG5pbXBvcnQgeyBjcmVhdGVEZWxpdmVyeSwgZ2V0RmVlIH0gZnJvbSBcIi4uL2xpYi93b2x0XCI7XG5pbXBvcnQgeyBnZXREdW1wTG9jYXRpb24gfSBmcm9tIFwiLi4vbGliL2R1bXBsb2NhdGlvblwiO1xuaW1wb3J0IFVzZXIgZnJvbSBcIi4uL21vZGVscy91c2VyXCI7XG5jb25zdCByb3V0ZXIgPSBSb3V0ZXIoKTtcblxucm91dGVyLmdldChcIi9hcGkvZHJvcG9mZnNcIiwgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIC8vIGdldCBhbGwgZHJvcG9mZnNcbiAgY29uc3QgZHJvcG9mZnMgPSBhd2FpdCBEcm9wb2ZmLmZpbmQoe30pO1xuICByZXR1cm4gcmVzLmpzb24oZHJvcG9mZnMpO1xufSk7XG5cbnJvdXRlci5wb3N0KFwiL2FwaS9saXN0aW5nL2RlbGl2ZXJ5cHJpY2VcIiwgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIC8vIGdldCBkZWxpdmVyeSBwcmljZVxuICBjb25zdCB7IG9yZGVySWQsIGFkZHJlc3MgfSA9IHJlcS5ib2R5O1xuICBjb25zdCBvcmRlciA9IGF3YWl0IE9yZGVyLmZpbmRCeUlkKG9yZGVySWQpO1xuICBpZiAoIW9yZGVyKSB7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgIG1lc3NhZ2U6IFwiT3JkZXIgbm90IGZvdW5kXCIsXG4gICAgfSk7XG4gIH1cbiAgY29uc3QgZHJvcG9mZiA9IGF3YWl0IERyb3BvZmYuZmluZEJ5SWQob3JkZXIuZHJvcG9mZik7XG4gIGlmICghZHJvcG9mZikge1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICBtZXNzYWdlOiBcIkRyb3BvZmYgbm90IGZvdW5kXCIsXG4gICAgfSk7XG4gIH1cblxuICBjb25zdCBmZWUgPSBhd2FpdCBnZXRGZWUoZHJvcG9mZi5hZGRyZXNzLCBhZGRyZXNzKTtcbiAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICBmZWUsXG4gIH0pO1xufSk7XG5cbnJvdXRlci5wb3N0KFwiL2FwaS9idXlcIiwgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIC8vIGJ1eVxuICBjb25zb2xlLmxvZyhyZXEuYm9keSlcbiAgY29uc3QgeyBvcmRlcklkLCDJmWRkcmVzcyB9ID0gcmVxLmJvZHk7XG4gIGNvbnNvbGUubG9nKFwiQUREUkVTUyBJU1wiLCDJmWRkcmVzcylcbiAgY29uc3Qgb3JkZXIgPSBhd2FpdCBPcmRlci5maW5kQnlJZChvcmRlcklkKTtcbiAgaWYgKCFvcmRlciB8fCBvcmRlci5zdGF0dXMgIT09IFwicGVuZGluZ1wiKSB7XG4gICAgcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgbWVzc2FnZTogXCJPcmRlciBub3QgZm91bmRcIixcbiAgICB9KTtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgZHJvcG9mZiA9IGF3YWl0IERyb3BvZmYuZmluZEJ5SWQob3JkZXIuZHJvcG9mZik7XG4gIGlmICghZHJvcG9mZikge1xuICAgIHJlcy5zdGF0dXMoNDAwKS5qc29uKHtcbiAgICAgIG1lc3NhZ2U6IFwiRHJvcG9mZiBub3QgZm91bmRcIixcbiAgICB9KTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBzZWxsZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKG9yZGVyLnVzZXIpO1xuXG4gIGlmKCFzZWxsZXIpIHtcbiAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICBtZXNzYWdlOiBcIlNlbGxlciBub3QgZm91bmRcIixcbiAgICB9KTtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYoIXJlcS51c2VyKXtcbiAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICBtZXNzYWdlOiBcIlVzZXIgbm90IGZvdW5kXCIsXG4gICAgfSk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnNvbGUubG9nKGRyb3BvZmYsIMmZZGRyZXNzLCBzZWxsZXIuZW1haWwsIHNlbGxlci5waG9uZSwgcmVxLnVzZXIsIG9yZGVyLl9pZClcbiAgY29uc3QgZGVsaXZlcnkgPSBhd2FpdCBjcmVhdGVEZWxpdmVyeShcbiAgICBkcm9wb2ZmLmFkZHJlc3MsXG4gICAgyZlkZHJlc3MsXG4gICAgYGRyb3BvZmYgLSAke1wiTW9pXCJ9IC0gJHtcImNvbW1lbnRcIn1gLFxuICAgIHtcbiAgICAgIG5hbWU6IHNlbGxlci5lbWFpbCxcbiAgICAgIHBob25lOiBzZWxsZXIucGhvbmUsXG4gICAgfSxcbiAgICB7XG4gICAgICBuYW1lOiByZXEudXNlci5lbWFpbCxcbiAgICAgIHBob25lOiByZXEudXNlci5waG9uZSxcbiAgICB9LFxuICAgIFwiZG9naVwiLFxuICAgIFwiRWxlY3Ryb25pc1wiLFxuICAgIG9yZGVyLl9pZC50b1N0cmluZygpLFxuICAgIFwia29pcmFcIlxuICApXG4gIG9yZGVyLnN0YXR1cyA9IFwiYm91Z2h0XCI7XG4gIGF3YWl0IG9yZGVyLnNhdmUoKTtcbiAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICBkZWxpdmVyeVxuICB9KTtcbn0pO1xuXG5yb3V0ZXIucG9zdChcIi9hcGkvZmVlXCIsIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBjb25zdCB7IGRyb3BvZmZJZCwgY2F0ZWdvcnkgfSA9IHJlcS5ib2R5IGFzIHtcbiAgICBkcm9wb2ZmSWQ6IHN0cmluZztcbiAgICBjYXRlZ29yeTogc3RyaW5nO1xuICB9O1xuICBjb25zdCBkcm9wb2ZmID0gYXdhaXQgRHJvcG9mZi5maW5kQnlJZChkcm9wb2ZmSWQpO1xuICBpZiAoIWRyb3BvZmYpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgbWVzc2FnZTogXCJEcm9wb2ZmIG5vdCBmb3VuZFwiLFxuICAgIH0pO1xuICB9XG4gIGNvbnN0IGR1bXBMb2NhdGlvbiA9IGF3YWl0IGdldER1bXBMb2NhdGlvbihkcm9wb2ZmLmxhdCwgZHJvcG9mZi5sb24sIGNhdGVnb3J5KTtcbiAgY29uc3QgZmVlID0gYXdhaXQgZ2V0RmVlKGRyb3BvZmYuYWRkcmVzcywgZHVtcExvY2F0aW9uLnN0cmVldEFkZHJlc3MpO1xuICByZXR1cm4gcmVzLmpzb24oZmVlKTtcbn0pO1xuXG5cblxucm91dGVyLmdldChcIi9hcGkvbGlzdGluZ1wiLCBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgaWYoIXJlcS51c2VyKXtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIixcbiAgICB9KTtcbiAgfVxuICBjb25zdCBvcmRlcnMgPSBhd2FpdCBPcmRlci5maW5kKHtzdGF0dXM6IFwicGVuZGluZ1wifSk7XG4gIHJldHVybiByZXMuanNvbihvcmRlcnMpO1xufSlcblxucm91dGVyLnBvc3QoXCIvYXBpL2xpc3RpbmdcIiwgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIHRyeSB7ICBcbiAgICBpZighcmVxLnVzZXIpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6IFwiWW91IG11c3QgYmUgbG9nZ2VkIGluXCIsXG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc29sZS5sb2cocmVxLmJvZHkpXG4gICAgY29uc3QgeyBkcm9wb2ZmSWQsIHRpdGxlLCBjYXRlZ29yeSwgcHJpY2UgfSA9IHJlcS5ib2R5IGFzIHtcbiAgICAgIGRyb3BvZmZJZDogc3RyaW5nO1xuICAgICAgdGl0bGU6IHN0cmluZztcbiAgICAgIGNhdGVnb3J5OiBzdHJpbmc7XG4gICAgICBwcmljZTogbnVtYmVyO1xuICAgIH07XG4gICAgY29uc3QgZHJvcG9mZiA9IGF3YWl0IERyb3BvZmYuZmluZEJ5SWQoZHJvcG9mZklkKTtcbiAgICBpZiAoIWRyb3BvZmYpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7XG4gICAgICAgIG1lc3NhZ2U6IFwiRHJvcG9mZiBub3QgZm91bmRcIixcbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCBvcmRlciA9IG5ldyBPcmRlcih7XG4gICAgICBkcm9wb2ZmLFxuICAgICAgdXNlcjogcmVxLnVzZXIsXG4gICAgICB0aXRsZTogdGl0bGUsXG4gICAgICBjYXRlZ29yeTogY2F0ZWdvcnksXG4gICAgICBwcmljZSxcbiAgICAgIHN0YXR1czogXCJwZW5kaW5nXCJcbiAgICB9KTtcbiAgICBhd2FpdCBvcmRlci5zYXZlKCk7XG4gICAgY29uc29sZS5sb2coXCJyZWFkeVwiKVxuICAgIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbih7IFwiZG9nXCI6IFwiY2F0XCIgfSlcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUubG9nKGUpXG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKVxuICB9XG59KTtcblxucm91dGVyLnBvc3QoXCIvYXBpL29yZGVyXCIsIGFzeW5jIChyZXEsIHJlcykgPT4ge1xuICBpZighcmVxLnVzZXIpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgbWVzc2FnZTogXCJZb3UgbXVzdCBiZSBsb2dnZWQgaW5cIixcbiAgICB9KTtcbiAgfVxuICBjb25zdCB7IGRyb3BvZmZJZCwgdGl0bGUsIGNhdGVnb3J5IH0gPSByZXEuYm9keSBhcyB7XG4gICAgZHJvcG9mZklkOiBzdHJpbmc7XG4gICAgdGl0bGU6IHN0cmluZztcbiAgICBjYXRlZ29yeTogc3RyaW5nO1xuICB9O1xuICBjb25zdCBkcm9wb2ZmID0gYXdhaXQgRHJvcG9mZi5maW5kQnlJZChkcm9wb2ZmSWQpO1xuICBpZiAoIWRyb3BvZmYpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgbWVzc2FnZTogXCJEcm9wb2ZmIG5vdCBmb3VuZFwiLFxuICAgIH0pO1xuICB9XG4gICAgXG4gIGNvbnN0IGR1bXBMb2NhdGlvbiA9IGF3YWl0IGdldER1bXBMb2NhdGlvbihkcm9wb2ZmLmxhdCwgZHJvcG9mZi5sb24sIGNhdGVnb3J5KTtcbiAgbGV0IGRlbGl2ZXJ5O1xuICB0cnkge1xuXG4gICAgZGVsaXZlcnkgPSBhd2FpdCBjcmVhdGVEZWxpdmVyeShcbiAgICAgIGRyb3BvZmYuYWRkcmVzcyxcbiAgICAgIGR1bXBMb2NhdGlvbi5zdHJlZXRBZGRyZXNzLFxuICAgICAgXCJkcm9wb2ZmIGJveCAtIFwiICsgdGl0bGUgKyBcIiAtIFwiICsgY2F0ZWdvcnksXG4gICAgICB7XG4gICAgICAgIG5hbWU6IHJlcS51c2VyLmVtYWlsLFxuICAgICAgICBwaG9uZTogcmVxLnVzZXIucGhvbmUgfHwgXCIrMzU4NDA0MzQyMzQyXCIsXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBuYW1lOiBkdW1wTG9jYXRpb24uc3RyZWV0QWRkcmVzcyxcbiAgICAgICAgcGhvbmU6IGR1bXBMb2NhdGlvbi5waG9uZU51bWJlcixcbiAgICAgIH0sXG4gICAgICB0aXRsZSxcbiAgICAgIGNhdGVnb3J5LFxuICAgICAgXCJcIixcbiAgICAgIFwiXCJcbiAgICApO1xuICAgIC8vIGNyZWF0ZSBhIG5ldyBvcmRlciBhbmQgc2F2ZSBpdCB0byBtb25nb2RiXG4gICAgXG4gIH0gY2F0Y2goZXJyKXtcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgbWVzc2FnZTogXCJFcnJvciBjcmVhdGluZyBkZWxpdmVyeVwiLFxuICAgIH0pO1xuICB9XG4gIFxuICByZXR1cm4gcmVzLmpzb24oe1xuICAgIGRlbGl2ZXJ5XG4gIH0pO1xufSk7XG5cbnJvdXRlci5nZXQoXCIvYXBpL2hpc3RvcnlcIiwgYXN5bmMgKHJlcSwgcmVzKSA9PiB7XG4gIHRyeSB7XG4gIGNvbnN0IG9yZGVyc0J5VXNlciA9IGF3YWl0IE9yZGVyLmZpbmQoe3VzZXI6IHJlcS51c2VyPy5faWR9KVxuICBjb25zb2xlLmxvZyhvcmRlcnNCeVVzZXIpXG4gIHJldHVybiByZXMuc3RhdHVzKDIwMCkuanNvbihvcmRlcnNCeVVzZXIpXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUubG9nKGVycilcbiAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe21lc3NhZ2U6IFwic29tZSBlcnJvclwifSlcbiAgfVxufSlcblxuXG5leHBvcnQgZGVmYXVsdCByb3V0ZXI7Il19